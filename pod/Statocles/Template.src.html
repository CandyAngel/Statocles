<!DOCTYPE html>
<html>
    <head>
        <link href="/Statocles/theme/css/normalize.css" rel="stylesheet">
        <link href="/Statocles/theme/css/skeleton.css" rel="stylesheet">
        <link href="/Statocles/theme/css/statocles-default.css" rel="stylesheet">
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
        <title>Statocles</title>
        <link href="http://fonts.googleapis.com/css?family=Forum" rel="stylesheet" type="text/css">
<style>
    h1, h2, h3, h4, h5, h6 {
        font-family: 'Forum', sans-serif;
        font-weight: bold;
    }

    #index-banner {
        font-family: 'Forum', sans-serif;
        height: 300px;
        position: relative;
        margin-bottom: 1em;
        border-bottom: 1px solid #777
    }
    #index-banner:before, #index-banner:after {
        width: 60px;
        height: 300px;
        content: url(/Statocles/theme/images/column.png);
    }
    #index-banner:before {
        position: absolute;
        top: 0;
        left: 0;
    }
    #index-banner:after {
        position: absolute;
        top: 0;
        right: 0;
    }

    #index-banner h1 {
        padding-top: 1em;
        text-transform: uppercase;
        font-size: 72px;
        text-align: center;
    }
    #index-banner h1 small {
        display: block;
        font-size: 24px;
    }

    #index-banner .latest-release {
        text-align: center;
    }

</style>

    </head>
    <body>
        <header>
            <nav class="navbar">
                <div class="container">
                    <a class="brand" href="/">Statocles</a>
                    <ul>
                        <li>
                            <a href="/Statocles/blog">Blog</a>
                        </li>
                        <li>
                            <a href="/Statocles/pod">Docs</a>
                        </li>
                        <li>
                            <a href="/Statocles/gallery">Gallery</a>
                        </li>
                        <li>
                            <a href="http://github.com/preaction/Statocles">Code</a>
                        </li>
                        <li>
                            <a href="http://github.com/preaction/Statocles/issues">Bugs</a>
                        </li>
                        <li>
                            <a href="http://metacpan.org/pod/Statocles">CPAN</a>
                        </li>
                        <li>
                            <a href="https://chat.mibbit.com/?channel=%23statocles&amp;server=irc.perl.org">IRC</a>
                        </li>
                    </ul>
                </div>
            </nav>
            <a href="https://github.com/preaction/Statocles"><img alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" style="position: absolute; top: 0; right: 0; z-index: 1000; border: 0;"></a>

        </header>
        <div class="main container">
            <a href="/Statocles/pod/Statocles/Template.html">Back to documentation</a>
<pre>package Statocles::Template;
# ABSTRACT: A template object to pass around

use Statocles::Base &#39;Class&#39;;
use Mojo::Template;
use Scalar::Util qw( blessed );

=attr content

The main template string. This will be generated by reading the file C&lt;path&gt; by
default.

=cut

has content =&gt; (
    is =&gt; &#39;ro&#39;,
    isa =&gt; Str,
    lazy =&gt; 1,
    default =&gt; sub {
        my ( $self ) = @_;
        return Path::Tiny-&gt;new( $self-&gt;path )-&gt;slurp;
    },
);

=attr path

The path to the file for this template. Optional.

=cut

has path =&gt; (
    is =&gt; &#39;ro&#39;,
    isa =&gt; Str,
    coerce =&gt; sub {
        return &quot;$_[0]&quot;; # Force stringify in case of Path::Tiny objects
    },
);

=attr include_stores

One or more stores to use for includes. Optional.

=cut

has include_stores =&gt; (
    is =&gt; &#39;ro&#39;,
    isa =&gt; ArrayRef[Store],
    default =&gt; sub { [] },
    coerce =&gt; sub {
        my ( $thing ) = @_;
        if ( ref $thing eq &#39;ARRAY&#39; ) {
            return [ map { Store-&gt;coercion-&gt;( $_ ) } @$thing ];
        }
        return [ Store-&gt;coercion-&gt;( $thing ) ];
    },
);

=method BUILDARGS( )

Set the default path to something useful for in-memory templates.

=cut

around BUILDARGS =&gt; sub {
    my ( $orig, $self, @args ) = @_;
    my $args = $self-&gt;$orig( @args );
    if ( !$args-&gt;{path} ) {
        my ( $i, $caller_class ) = ( 0, (caller 0)[0] );
        while ( $caller_class-&gt;isa( &#39;Statocles::Template&#39; )
            || $caller_class-&gt;isa( &#39;Sub::Quote&#39; )
            || $caller_class-&gt;isa( &#39;Method::Generate::Constructor&#39; )
        ) {
            #; say &quot;Class: $caller_class&quot;;
            $i++;
            $caller_class = (caller $i)[0];
        }
        #; say &quot;Class: $caller_class&quot;;
        $args-&gt;{path} = join &quot; line &quot;, (caller($i))[1,2];
    }
    return $args;
};

=method render( %args )

Render this template, passing in %args. Each key in %args will be available as
a scalar in the template.

=cut

sub render {
    my ( $self, %args ) = @_;
    my $t = Mojo::Template-&gt;new(
        name =&gt; $self-&gt;path,
    );
    $t-&gt;prepend( $self-&gt;_prelude( &#39;_tmpl&#39;, keys %args ) );

    my $content;
    {
        # Add the helper subs, like Mojolicious::Plugin::EPRenderer does
        no strict &#39;refs&#39;;
        no warnings &#39;redefine&#39;;
        local *{&quot;@{[$t-&gt;namespace]}::include&quot;} = sub {
            $self-&gt;_include( \%args, @_ );
        };
        $content = $t-&gt;render( $self-&gt;content, \%args );
    }

    if ( blessed $content &amp;&amp; $content-&gt;isa( &#39;Mojo::Exception&#39; ) ) {
        die &quot;Error in template: &quot; . $content;
    }
    return $content;
}

# Build the Perl string that will unpack the passed-in args
# This is how Mojolicious::Plugin::EPRenderer does it, but I&#39;m probably
# doing something wrong here...
sub _prelude {
    my ( $self, @vars ) = @_;
    return join &quot; &quot;,
        &#39;use strict; use warnings; no warnings &quot;ambiguous&quot;;&#39;,
        &#39;my $vars = shift;&#39;,
        map( { &quot;my \$$_ = \$vars-&gt;{&#39;$_&#39;};&quot; } @vars ),
        ;
}


# Find and include the given file. If it&#39;s a template, give it the given vars
sub _include {
    my ( $self, $vars, $name, %args ) = @_;

    for my $store ( @{ $self-&gt;include_stores } ) {
        if ( $store-&gt;has_file( $name ) ) {
            if ( $name =~ /[.]ep$/ ) {
                my $inner_tmpl = __PACKAGE__-&gt;new(
                    path =&gt; &quot;$name&quot;,
                    content =&gt; $store-&gt;read_file( &quot;$name&quot; ),
                    store =&gt; $store,
                );
                return $inner_tmpl-&gt;render( %$vars, %args ) || &#39;&#39;;
            }

            return $store-&gt;read_file( $name );
        }
    }

    die qq{Can not find include &quot;$name&quot;};
}

=method coercion

A class method to returns a coercion sub to convert strings into template
objects.

=cut

sub coercion {
    my ( $class ) = @_;
    return sub {
        die &quot;Template is undef&quot; unless defined $_[0];
        return !ref $_[0]
            ? Statocles::Template-&gt;new( content =&gt; $_[0] )
            : $_[0]
            ;
    };
}

1;
__END__

=head1 DESCRIPTION

This is the template abstraction layer for Statocles.

=head1 TEMPLATE LANGUAGE

The default Statocles template language is Mojolicious&#39;s Embedded Perl
template. Inside the template, every key of the %args passed to render() will
be available as a simple scalar:

    # template.tmpl
    % for my $p ( @$pages ) {
    &lt;%= $p-&gt;{content} %&gt;
    % }

    my $tmpl = Statocles::Template-&gt;new( path =&gt; &#39;template.tmpl&#39; );
    $tmpl-&gt;render(
        pages =&gt; [
            { content =&gt; &#39;foo&#39; },
            { content =&gt; &#39;bar&#39; },
        ]
    );

=head1 SEE ALSO

=over 4

=item L&lt;Statocles::Help::Theme&gt;

=item L&lt;Statocles::Theme&gt;

=back
</pre>

        </div>
        <footer>
            <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61295159-3', 'auto');
  ga('send', 'pageview');

</script>

            <div class="container tagline">
                <a href="http://preaction.github.io/Statocles">Made with Statocles</a><br>
                <a href="http://www.perl.org">Powered by Perl</a>
            </div>
        </footer>
    </body>
</html>
