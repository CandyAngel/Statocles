<!DOCTYPE html>
<html>
    <head>
        <link href="/Statocles/theme/css/normalize.css" rel="stylesheet">
        <link href="/Statocles/theme/css/skeleton.css" rel="stylesheet">
        <link href="/Statocles/theme/css/statocles-default.css" rel="stylesheet">
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
        <title>Statocles</title>
        <link href="http://fonts.googleapis.com/css?family=Forum" rel="stylesheet" type="text/css">
<style>
    h1, h2, h3, h4, h5, h6 {
        font-family: 'Forum', sans-serif;
        font-weight: bold;
    }

    #index-banner {
        font-family: 'Forum', sans-serif;
        height: 300px;
        position: relative;
        margin-bottom: 1em;
        border-bottom: 1px solid #777
    }
    #index-banner:before, #index-banner:after {
        width: 60px;
        height: 300px;
        content: url(/Statocles/theme/images/column.png);
    }
    #index-banner:before {
        position: absolute;
        top: 0;
        left: 0;
    }
    #index-banner:after {
        position: absolute;
        top: 0;
        right: 0;
    }

    #index-banner h1 {
        padding-top: 1em;
        text-transform: uppercase;
        font-size: 72px;
        text-align: center;
    }
    #index-banner h1 small {
        display: block;
        font-size: 24px;
    }

    #index-banner .latest-release {
        text-align: center;
    }

</style>

    </head>
    <body>
        <header>
            <nav class="navbar">
                <div class="container">
                    <a class="brand" href="/Statocles/">Statocles</a>
                    <ul>
                        <li>
                            <a href="/Statocles/blog">Blog</a>
                        </li>
                        <li>
                            <a href="/Statocles/pod">Docs</a>
                        </li>
                        <li>
                            <a href="/Statocles/gallery">Gallery</a>
                        </li>
                        <li>
                            <a href="http://github.com/preaction/Statocles">Code</a>
                        </li>
                        <li>
                            <a href="http://github.com/preaction/Statocles/issues">Bugs</a>
                        </li>
                        <li>
                            <a href="http://metacpan.org/pod/Statocles">CPAN</a>
                        </li>
                        <li>
                            <a href="https://chat.mibbit.com/?channel=%23statocles&amp;server=irc.perl.org">IRC</a>
                        </li>
                    </ul>
                    
                </div>
            </nav>
            <a href="https://github.com/preaction/Statocles"><img alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" style="position: absolute; top: 0; right: 0; z-index: 1000; border: 0;"></a>

        </header>
        <div class="main container">
            <a class="button" href="/Statocles/pod/Statocles/Deploy/Git.html">
    Back to documentation
</a>
<pre>package Statocles::Deploy::Git;
# ABSTRACT: Deploy a site to a Git repository

use Statocles::Base &#39;Class&#39;;
extends &#39;Statocles::Deploy::File&#39;;

use Git::Repository;

=attr path

The path to deploy to. Must be the root of the Git repository, or a directory
inside of the Git repository.

=attr branch

The Git branch to deploy to. Defaults to &quot;master&quot;. If you&#39;re building a Github Pages
site for a project, you probably want to use the &quot;gh-pages&quot; branch.

=cut

has branch =&gt; (
    is =&gt; &#39;ro&#39;,
    isa =&gt; Str,
    default =&gt; sub { &#39;master&#39; },
);

=attr remote

The name of the remote to deploy to. Defaults to &#39;origin&#39;.

=cut

has remote =&gt; (
    is =&gt; &#39;ro&#39;,
    isa =&gt; Str,
    default =&gt; sub { &#39;origin&#39; },
);

=method deploy

    my @paths = $deploy-&gt;deploy( $from_store, $message );

Deploy the site, copying from the given L&lt;from_store|Statocles::Store&gt; with the
given commit message (if applicable). Returns the paths that were deployed.

=cut

around &#39;deploy&#39; =&gt; sub {
    my ( $orig, $self, $from_store, $message ) = @_;

    my $deploy_dir = $self-&gt;path;

    # Find the repository root
    my $root = Path::Tiny-&gt;new( &quot;$deploy_dir&quot; ); # clone
    until ( $root-&gt;child( &#39;.git&#39; )-&gt;exists || $root-&gt;is_rootdir ) {
        $root = $root-&gt;parent;
    }
    if ( !$root-&gt;child( &#39;.git&#39; )-&gt;exists ) {
        die qq{Deploy path &quot;$deploy_dir&quot; is not in a git repository\n};
    }
    my $rel_path = $deploy_dir-&gt;relative( $root );
    #; say &quot;Relative: $rel_path&quot;;

    my $git = Git::Repository-&gt;new( work_tree =&gt; &quot;$root&quot; );

    # Switch to the right branch
    my $current_branch = _current_branch( $git );
    if ( !_has_branch( $git, $self-&gt;branch ) ) {
        # Create a new, orphan branch
        # Orphan branches were introduced in git 1.7.2
        _git_run( $git, checkout =&gt; &#39;--orphan&#39;, $self-&gt;branch );
        _git_run( $git, &#39;rm&#39;, &#39;-r&#39;, &#39;-f&#39;, &#39;.&#39; );
    }
    else {
        _git_run( $git, checkout =&gt; $self-&gt;branch );
    }

    # Copy the files
    my @files = $self-&gt;$orig( $from_store, $message );

    # Check to see which files were changed
    # --porcelain was added in 1.7.0
    my @status_lines = $git-&gt;run(
        status =&gt; &#39;--porcelain&#39;, &#39;--ignore-submodules&#39;, &#39;--untracked-files&#39;,
    );

    my %in_status;
    for my $line ( @status_lines ) {
        my ( $status, $path ) = $line =~ /^\s*(\S+)\s+(.+)$/;
        $in_status{ $path } = $status;
    }

    #; use Data::Dumper;
    #; say Dumper \%in_status;

    # Commit the files
    @files    = grep { $in_status{ $_ } }
                map { Path::Tiny-&gt;new( $rel_path, $_ ) }
                @files;

    #; say &quot;Committing: &quot; . Dumper \@files;
    return if !@files;

    _git_run( $git, add =&gt; @files );
    _git_run( $git, commit =&gt; -m =&gt; $message || &quot;Site update&quot; );
    if ( _has_remote( $git, $self-&gt;remote ) ) {
        _git_run( $git, push =&gt; $self-&gt;remote =&gt; $self-&gt;branch );
    }

    # Tidy up
    _git_run( $git, checkout =&gt; $current_branch );

    return @files;
};

sub _git_run {
    my ( $git, @args ) = @_;
    my $cmdline = join &quot; &quot;, &#39;git&#39;, @args;
    my $cmd = $git-&gt;command( @args );
    my $stdout = join( &quot;\n&quot;, readline( $cmd-&gt;stdout ) ) // &#39;&#39;;
    my $stderr = join( &quot;\n&quot;, readline( $cmd-&gt;stderr ) ) // &#39;&#39;;
    $cmd-&gt;close;
    my $exit = $cmd-&gt;exit;

    if ( $exit ) {
        die &quot;git $args[0] exited with $exit\n\n-- CMD --\n$cmdline\n\n-- STDOUT --\n$stdout\n\n-- STDERR --\n$stderr\n&quot;;
    }

    return $cmd-&gt;exit;
}

sub _current_branch {
    my ( $git ) = @_;
    my @branches = map { s/^\*\s+//; $_ } grep { /^\*/ } $git-&gt;run( &#39;branch&#39; );
    return $branches[0];
}

sub _has_branch {
    my ( $git, $branch ) = @_;
    return !!grep { $_ eq $branch } map { s/^[\*\s]\s+//; $_ } $git-&gt;run( &#39;branch&#39; );
}

sub _has_remote {
    my ( $git, $remote ) = @_;
    return !!grep { $_ eq $remote } map { s/^[\*\s]\s+//; $_ } $git-&gt;run( &#39;remote&#39; );
}

sub _git_version {
    my $git_version = ( split &#39; &#39;, `git --version` )[-1];
    return unless $git_version;
    my $v = sprintf &#39;%i.%03i%03i&#39;, split /[.]/, $git_version;
    return $v;
}

1;
__END__

=head1 DESCRIPTION

This class allows a site to be deployed to a Git repository.

This class extends L&lt;Statocles::Store::File|Statocles::Store::File&gt;.

=head1 SEE ALSO

=over 4

=item L&lt;Statocles::Store::File&gt;

=item L&lt;Statocles::Deploy&gt;

=back

</pre>

        </div>
        <footer>
            <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61295159-3', 'auto');
  ga('send', 'pageview');

</script>

            <div class="container tagline">
                <a href="http://preaction.github.io/Statocles">Made with Statocles</a><br>
                <a href="http://www.perl.org">Powered by Perl</a>
            </div>
        </footer>
    </body>
</html>
